---
layout: article
---
Как видишь, у нас теперь два Dockerfiles. Первый, когда я инициирую сборку приложения в среде nodejs. Здесь каждый раз с нуля происходит создание моего приложения. На втором шаге я упаковываю приложение в готовый образ, где будет запущен веб-сервер nginx, и из него код будет отгружаться в браузер конечного пользователя. 

Каждый раз, когда я вношу изменения в мое приложение, я сначала собираю образ из первого Dockerfile, а далее, когда этот первый временный образ готов, я создаю второй постоянный образ, который будет содержать результат работы первого.

Вот именно второй образ - это ценный для меня результат, именно он готов к работе в продакшене. Судьба первого образа мне не интересна, из него меня интересует только dist-пакет с моим приложением. Чтобы не путаться я задал название первому образу как `builder`, а второму `my-dashboard`. 

В данный момент, когда сборка превого Dockerfile закончена, нужные мне данные лежат внутри образа `builder`. Мне нужно найти способ, чтобы доставить этот каталог `dist` из `builder` в образ `my-dashboard`. Я могу написать скрипт, который будет извлекать готовый каталог `dist` наружу хоста в какое-то место. Далее команда `docker build` для образа `my-dashboard` сможет забрать готовый код приложения с хоста и сохранить в своём продуктовом образе.

Таким образом у меня появляется еще один этап, который находится между этими двумя. Я назову его `Extract Artifact`, поскольку это `извлечение пакета из builder`. Т.е. у нас три этапа: сборка, извлечение готового приложения и упаковка в продуктовый образ.

```
copy-dist-from-builder.sh
```

Что именно будет делать подобный скрипт? После того, как новая версия образа `builder` станет доступна, он создаст контейнер из этого образа (я назову этот контейнер `builder-for-copy`) и скопирует на хост нужный нам каталог. Контейнер для этого запускать не обязательно, достаточно лишь создать его. После получения файлов на хост контейнер `builder-for-copy` нам больше не нужен, и я удалю его.

Теперь каталог со свежесобранным приложением доступен локально с хоста. Он находится в той же папке, где лежат оба наши Dockerfiles. Таким образом, я могу запустить третью стадию, которая соберет образ `my-dashboard`, скопировав туда директорию `dist`. На этом моя процедура сборки закончена. Как и планировал, я получил готовый к продуктовому развертыванию образ со своим приложением.

Ок, давай еще раз окинем взглядом наш механизм сборки. Процедура состоит из трех шагов:
-   сначала мы создаем `builder`, задача которого собрать в себе каталог с готовым nodejs-приложением.
-   далее у нас работает скрипт оболочки `copy-dist-from-builder.sh`, который забирает готовый артефакт (каталог `dist`) из временного контейнера-билдера
-   на последней стадии мы собираем наш продуктовый веб-сервер, разместив в нем dist-каталог

Как видишь, это не совсем простой и поначалу не всем понятный процесс. Вот для таких ситуаций в Docker есть способ, который убирает промежуточную сложность.
