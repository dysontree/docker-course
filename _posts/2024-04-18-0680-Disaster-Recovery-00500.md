---
layout: article
---

На каждом docker-хосте хранятся данные о объектах, которыми управляет этот демон. Они располагаются в каталоге `/var/lib/docker`. На узле swarm-менеджера дополнительно хранятся данные о кластере по пути `/var/lib/docker/swarm`. Это данные RAFT-базы данных, о которой мы уже говорили. В ней лежат данные, которые нужны для восстановлении служб, объектов конфигурации и другой информации об этом swarm-кластере. И именно это нам нужно бэкапить, чтобы иметь возможность восстановиться, подобно той истории, когда мы утратили два менеджера.

Чтобы сделать резервную копию базы данных Swarm, нужно сначала остановить службу `docker`:

```
systemctl stop docker
```

затем создать tar-архив с данными кластера:

```
tar -cvzf swarm-backup.tgz /var/lib/docker/swarm
```

Содержимое этого каталога реплицируется по всем менеджерам, поэтому на всех он будет одинаковым. Однако, нам пришлось остановить dockerd. Это спровоцирует выборы нового лидера в кластере. Поэтому лучше делать бэкап не с лидера. Также стоит запланировать снятие копии на спокойное время, когда в кластере минимум бизнес-задач, поскольку остановка менеджера увеличивает риск потери кворума.

В нашем примере мы можем не беспокоится за это, поскольку у нас всего лишь один управляющий узел. После того, как мы остановили этого менеджера, управления кластером не осуществляется. Но приложения, продолжают исполняться на рабочих узлах как обычно. В среде с несколькими менеджерами у нас будет высокая доступность, поэтому отключение на короткий период одного из нелидерских менеджеров никак не проявится.

Имей в виду, что это основная идея резервного копирования, но прежде чем ты начнёшь это практиковать прочитай `Admin Guide` из документации, возможно там что-то изменилось.

`https://docs.docker.com/engine/swarm/admin_guide/`

Ок, мы сохранили архив, но что именно мы сохранили? Что там внутри?

Прежде всего, там ключи для шифрования связи между swarm-узлами. Далее там сведения о членстве в кластере. Далее идут объекты кластера: services, networks, configs, secrets. Это всё.

Тут важный момент. Мы говорили ранее о ключах для разблокировки swarm-кластера. Это ключи, которые используются защиты основных RAFT-лога.

Эти ключи не сохраняются как часть резервной копии. Поэтому, если у нас при инициализации была установлена функция `autolock`, то любое отключение демона потребует предоставление этого `unlock-key`.

```
docker swarm init --autolock=true
```

Этот ключ необходим и при восстановлении кластера, поэтому он должен храниться в надёжном месте, например, во внешнем менеджере паролей. Именно поэтому его нет в резервной копии. Если ты куда-то потерял этот ключ, то его можно легко восстановить с другого менеджера, запустив команду:

```
docker swarm unlock-key
```

Теперь о том, как восстановиться.
