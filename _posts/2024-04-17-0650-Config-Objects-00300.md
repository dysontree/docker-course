---
layout: article
---

Перенесёмся в swarm-кластер с несколькими узлами. Требования у нас те же - запуск nginx с собственным конфиг-файлом.

Итак, в примере у нас кластер с четырьмя нодами. Мы знаем, что для создания нагрузок в Swarm нам нужно использовать команду `docker service create`. Мы хотим несколько экземпляров, пусть это будут четыре реплики. Для этого используем ключ `--replicas=4` в команде.

```
docker service create --replicas=4 -v /tmp/nginx.conf:/etc/nginx/nginx.conf nginx
```

Таким образом, команда создает четыре экземпляра контейнера nginx на четырех разных хостах. А что насчет нужных нам привязок? 

В команде мы указали пути для монтирования, и каждый контейнер попытается смонтировать `nginx.conf` из каталога `/tmp` своей ноды в свою локальную файловую систему. Но получится это только у одного из четырёх. На остальных операция зафейлится, поскольку `nginx.conf` находится только на одном хосте. Когда Docker пытается создать контейнер, он не найдёт файла и выдаст ошибку.

Таким образом, работая в кластере мы должны подумать и позаботиться о том, чтобы монтирования, указанные в спецификации службы, были доступны на всех хостах, которые могут принять её экземпляры. Т.е. на каждом рабочем узле по пути `/tmp/nginx.conf` должна лежать копия нашего оригинального файла. У нас может быть сотня узлов в кластере, и всего четыре реплики службы. Но файл должен быть продублирован во всех `/tmp`-директориях, поскольку какой-то из контейнеров может выйти из строя, ведь мы точно не знаем, на каком из узлов он будет воссоздан. Также, нам надо быть уверенными, что при изменениях в файле, мы обновили его копии во всём нашем кластере, чтобы не получить дрифт конфигурации.

В больших кластерах это будет утомительной задачей. Хочется, чтобы файлы конфигураций автоматически доставлялись на ноды и при этом только туда, на которых действительно создаётся контейнер. Ещё хочется иметь какую-то единую точку управления этим файлом, чтобы внеся изменения в одном месте, распространялся уже обновлённый файл.
