---
layout: article
---

В реальной жизни настройки обычно сложнее. Например, у нас три дата-центра, и нам требуется держать по три реплики службы в каждом из них. В дата-центре `alpha` у нас 3 ноды, в `beta` две, а в `gamma` всего одна. Таким образом, на выходе мы предполагаем, что в первом ДЦ будет три ноды с одним контейнером, во втором одна нода с двумя и одна с одним контейнером, а в третьем все три реплики будут на единственной ноде.

Мы можем настроить что-то похожее это при помощи механизма `constraints`, и оно будет успешно работать, хотя это будет 3 службы. Docker Swarm позволяет решить это в одном сервисе при помощи параметра `--placement-pref`.

Наши ноды промаркированы такими метками:
- node.labels.datacenter=alpha
- node.labels.datacenter=beta
- node.labels.datacenter=gamma

```
docker service create --replicas 9 --placement-pref spread=node.labels.datacenter webserver
```

Этой инструкцией Swarm назначит нагрузки на узлы, содержащие метку `datacenter`, а также равномерно распределит реплики между нодами с разными значениями этой метки. Но это желаемое поведение, и если ресурсов на нодах не хватит, он поставит контейнеры на другие ноды, если это явно не запрещено.

Другая интересная возможность - использовать флаг `--replicas-max-per-node`.

Скажем, у нас есть есть требование иметь по одному экземпляру `webserver` во всех дата-центрах. Но мы хотим также, чтобы при нехватке ресурсов на ноде контейнер в ДЦ `gamma` не убегал бы из него. Для этого мы используем такую команду:

```
docker service create --replicas 3 --placement-pref spread=node.labels.datacenter --replicas-max-per-node 1  webserver
```

Теперь, если мы отключим единственную gamma-ноду, её контейнер не будет воссоздан в другом месте, поскольку в области действия метки `datacenter` может быть только одна реплика для значения метки. После отключения gamma у нас доступны ноды со значением `alpha` и `beta`, которые уже содержат по одной реплике. Поэтому планировщик будет ждать, пока не появятся доступные ноды с новым ключом.

Прежде чем мы закончим, небольшой момент об обновлении. Когда ты вносишь ограничения, ты сужаешь окно действий планировщика. Он берёт во внимание много вещей, но главный приоритет, чтобы работа любой из служб не прерывалась. За это отвечает конфигурация развёртывания - `updateConfig`, мы упоминали её в разделе `rolling updates`. По умолчанию значение порядка в ней `order: stop-first`. Это значит, что сначала убирается старая, а потом запускается новая версия. Такой подход не позволяет делать бесшовные развёртывания, и чтобы избежать downtime его можно изменить на `start-first`. Но если ты `задушил` планировщик ограничениями и включил режим `start-first`, то новая выкатка не сможет создаться, поскольку старая будет ей мешать. Имей это в виду.

И это всё, жду тебя в следующей лекции!
