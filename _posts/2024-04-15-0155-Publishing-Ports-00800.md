---
layout: article
---
Ок, мы поговорили о сопоставлении портов, о том, что есть порты в контейнерах, есть порты на хосте, и что мы можем прокинуть трафик с одного порта на другой. Но как на самом деле происходит эта передача? Как Docker добивается этого? Он открывает какой-то канал или портал? Никакой магии. Уровнем ниже он использует механизм фильтрации сетевых пакетов ядра Linux. А для настройки используются правила `iptables`.

Если ты ничего не слышал об iptables, вкратце это что-то вроде правил управления файрволом ядра Linux. В наше время этот механизм или его аналог являются брандмауэрами по умолчанию во многих системах Linux. Настроив эти правила, мы можем определить, какие системы могут взаимодействовать с нашим хостом, какие пакеты следует принимать, какие отбрасывать, какие пакеты пересылать в другое место и т. д.

В rotoro.cloud есть теоретически модуль об iptables, а также практические лабораторные в курсе `Основ Linux`. Рекомендую познакомиться с этим, если ты еще этого не сделал. Iptables имеет разные цепочки правил: INPUT, FORWARD, OUTPUT. Docker создает собственные цепочки под названием DOCKER, DOCKER-USER и некоторые другие. Эти цепочки содержат правила, созданные Docker. И именно по ним сетевой трафик, попавший на определенный порт хоста уходит на определенный порт контейнера.

Если ты хочешь просмотреть правила, созданные Docker для отдельного контейнера, запусти команду `iptables -t nat -S DOCKER`. Это перечислит правила в цепочке DOCKER.

```
iptables -t nat -S DOCKER
```

Здесь у нас два правила для последнего запущенного контейнера. Docker создал два сопоставления: 

- для порта 8080 внутреннего IP 172.17.0.2, который является адресом нашего контейнера с портом 32770 хоста.
- для порта 5000 внутреннего IP 172.17.0.3, который является адресом нашего контейнера с портом 32771 хоста.

Вот как работает маппинг портов. Никакой магии, только технология. На этом лекция закончена, увидимся в следующей.
