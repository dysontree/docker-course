---
layout: article
---

Чтобы использовать эту особенность мы можем определить в нашем Dockerfile инструкцию `HEALTHCHECK`. В ней мы прописываем текст команды. Эта директива сообщает docker-демону, что ему периодически требуется запускать эту команду внутри работающего контейнера, а результат работы команды будет показателем готовности контейнера к работе. В этом Docker полагается на коды выхода команды. Пока команда завершается с кодом ноль (0), Docker будет считать контейнер работоспособным. Любой другой exit code укажет Docker, что контейнеру `поплохело`.

```
FROM nginx
HEALTHCHECK CMD curl -f http://localhost/ || exit 1
EXPOSE 80
```

В этом примере Docker будет каждые 30 секунд запускать команду `curl -f http://localhost/` внутри контейнера. Если тест провалится, то контейнер будет помечен как `unhealthy`. Теперь задача наших инструментов мониторинга - отловить это событие и предпринять меры. В обычном режиме Docker не предпринимает никаких действий. Если он работает в `swarm mode`, то контейнер будет заменён.

`HEALTHCHECK` может быть командой или скриптом, находящимся внутри контейнера. Саму пробу можно гибко настроить, например, задать интервал вызова, задержку на первый вызов, количество попыток и т.д.

Если в Dockerfile не определено такой инструкции, или она нас не устраивает, мы можем переопределить ее при запуске контейнера. Вот пример, когда я запускаю собственную пробу в контейнере с nginx. Она проверяет наличие файла `nginx.conf` каждые 5 секунд. Если нет ответа более 1 секунды, я считаю, что тест провален, а также даю 15 секунд на то, чтобы контейнер запустился. В это время проверки не производятся:

```
docker container run --name=nginx-test -d --health-interval=5s --health-timeout=1s --health-start-period=15s --health-cmd='stat /etc/nginx/nginx.conf || exit 1' nginx
```

После запуска мы видим, что контейнер здоров.

```
docker container ls --filter name=nginx-test
```

Теперь удалим проверяемый файл из работающего контейнера:

```
docker container exec -it nginx-test rm -f /etc/nginx/nginx.conf
```

Через некоторое время он перейдет в состояние `unhealthy`.

```
docker container ls --filter name=nginx-test
```

Чтобы узнать, что именно пошло не так, мы можем использовать команду `inspect`:

```
docker container inspect nginx-test
```

Проверки состояния необязательны в учебной среде или при разработке. Но в проде являются необходимостью. Поэтому `боевые` развертывания всегда обносятся такими пробами.

И это всё, увидимся!
