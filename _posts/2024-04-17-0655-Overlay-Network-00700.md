---
layout: article
---

Мы добавили нод в наш swarm-кластер. Теперь у нас есть три ноды. В кластере две реплики веб-сервера, и они встали на два узла. Третий хост пока работает впустую, на нём ничего нет. Пока я не показываю здесь ingress-сеть. Сначала разберём, как это работает без неё.

В первую очередь, давай подумаем, куда попадёт запрос пользователя. Мы не знаем, где именно находится контейнер с веб-сервером. У нас кластер, что значит, что три машины работают как единый организм. Поэтому обращение на любой 80 порт любого хоста кластера должно привести пользователя к одному из экземпляров веб-сервера. Т.е. он может указать в браузере URL `192.168.1.11:80` или `192.168.1.12:80`, или `192.168.1.13:80`, но всё равно должен попасть на наш веб-сервер.

Без ingress network пользователь может получить доступ к веб-серверу, который исполняется на ноде #1 или на ноде #3. Но на ноде #2 нет контейнера с веб-сервером, поэтому запрос будет неудачным.

Теперь, давай вернемся к ingress и посмотрим отличия. Ingress network - это тип оверлейной сети. Оверлейная сеть - это сеть, которая охватывает несколько нод кластера. Таким образом, её балансировщик работает для всех нод кластера. Он отлавливает запрос на 80 порт на каждой ноде кластера и передает этот запрос на одину из нод, на которой исполняется экземпляр приложения. Создаётся так называемый `routing mesh`. Этот routing mesh помогает передавать трафик пользователя от получившей его ноды в целевую службу, даже если экземпляр этой службы здесь не исполняется. Таким образом трафик перенаправится на ноду, где действительно исполняется это приложение.

Ок, снова, это всё работает сразу и по умолчанию. С Docker Swarm нам не требуется какие-то дополнительные настройки, чтобы это заработало. Просто создаём сервис, указываем число реплик, какой порт публикуем и всё. Swarm равномерно распределит инстансы по нодам, опубликует порты на всех узлах, а пользователь может использовать IP любой ноды для доступа к приложению. Мы можем быть уверены, что внешний трафик достигнет правильных контейнеров, а ответ на запрос вернётся обратно к пользователю.
