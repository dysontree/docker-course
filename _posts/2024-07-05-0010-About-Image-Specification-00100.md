---
layout: article
---
Привет, несколько замечаний насчёт вариантов спецификаций docker-образов.

Итак, как ты помнишь, образ это набор слоёв + несколько файлов с мета-информацией для каждого слоя и для самого образа. Мы можем получить архив при помощи команды `docker image save`, а в распакованном виде образ имеет примерно такую структуру:

```
...
|-- f9bc8676543761ff3033813257937aeb77e9bc84296eaf025e27fe01643927cf
| |-- VERSION
| |-- json
| `-- layer.tar
|-- fefe8e8ca1eca9ce3eb25bc8049f6a644dddf9a7772ac92a80f2d59a59a90423
| |-- VERSION
| |-- json
| `-- layer.tar -> ../ccdf4498fb4159e4837b44ce7dd79139c35f4e66331e4d879f1a77753f9b58d2/layer.tar
|-- manifest.json
`-- repositories
```

В директории, куда мы его распаковали мы найдём файл manifest.json, который описывает слои образа, а сами слои будут лежать в каталогах с длинными IDs. Внутри каждого каталога слоя лежит tar-архив `layer.tar` с файлами слоя и файл параметрами этого слоя.

Такой порядок хранения файлов в образе называется docker-образом со схемой v1. До последнего времени она была очень распространена.

В 2016 Docker официально обновил свою спецификацию образа с V1 до V2. Новая структура манифестов принесла несколько преимуществ: она стала расширяемой, что позволило создавать образы для нескольких архитектур. Также образы, организованные по новой схеме, могли более гибко работать с данными внутри, что в дальнейшем позволило использовать реджистри не только в качестве хранилищ образов, но и других файловых артефактов ([см концепция ORAS](https://oras.land/)).

Во второй версии убрали случайно генерируемые image ID и перенесли мета-информацию каждого из слоёв на уровень образа. На базе этой спецификации был создана спецификация образа OCI. Образ имеет такую структуру:

```
├── blobs
│ └── sha256
│ ├── ...
│ ├── d635f9ec52adf2d7421e8d438696f89fd141dced85257f045cbdd31ac185aed1
│ └── e093badc077bef281fc9671716c30b0dc5125816828eed4915438af0d3a52efb
├── index.json
├── manifest.json
├── oci-layout
└── repositories
```

Все образы, загружаемые в Dockerhub хранятся в этом формате, но старые образы могут иметь первую версию.

Но независимо от версии образа, результат команды `docker image save` может по умолчанию сохранять файлы как в v1, так и в v2. Это зависит от версии хостового docker, а также использует ли docker собственное хранилище образов или делегирует это containerd. В любом случае, ты сохранишь архив с образом, а потом успешно сможешь его загрузить. Но если тебе вдруг потребуется вытащить файлы из подобного образа или обновить легаси-образ вручную, то ты можешь столкнуться со сложностями, поскольку внутри будет непривычная структура файлов. Надеюсь в тот момент ты вспомнишь эту статью, в которой я подсвечиваю, что образы могут иметь разные схемы.

Это всё, пока!
